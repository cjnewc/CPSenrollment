Reshape Your Data to the  Grammar of Your Graphics
========================================================
author: Charlotte Mack
date: `r format(Sys.Date(), '%B %d, %Y')`
autosize: true


A Tidy Dataset
========================================================
```{r libraries, echo = FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(readr)
library(forcats)
```
```{r data, echo = FALSE}
talk_dat <- read_csv("./satuRday/talk_dat.csv")
talk_dat %>% 
    select(-c(govern, school_id)) %>%
    arrange(common_name) %>%
    head()
talk_dat %>% 
    group_by(year) %>% 
    count()
```

Standard plots are easy with tidy data
========================================================
```{r by-year distribution code, eval = FALSE}
talk_dat %>% ggplot(aes(x = total_hs, y = ..density..)) +
    geom_density() + geom_histogram() + facet_wrap(~ year) 
```

```{r by-year distribution plots, echo = FALSE, fig.width = 12, fig.fullwidth = TRUE}
talk_dat %>% ggplot(aes(x = total_hs, y = ..density..)) +
    geom_density(size = 2, alpha = 1.0) +
    geom_histogram(alpha = 0.5, bins = 20) +
    facet_wrap(~ year) +
    labs(x = "Total High School Enrollment")
```

Un-tidying for a Side-by-side View
========================================================

```{r side-by-side}
ranked <- talk_dat %>% spread(year, total_hs, drop = TRUE) %>% 
    rename(hs_06 = `2006`, 
           hs_18 = `2018`) %>% 
    mutate(rank_06 = trunc(rank(-hs_06, ties.method = "min")), 
           rank_18 = trunc(rank(-hs_18, ties.method = "min"))) %>%
    arrange(rank_06) %>%
    select(-c(school_id, hs_06, hs_18))

ranked
```

Re-tidying to Plot a Side-by-side View
========================================================

<small>
```{r, eval = FALSE}
ranked %>% filter(rank_06 <= 15)  %>% 
    gather(key = rank_yr,  value = ranking, -common_name)
```
</small>
```{r, echo = FALSE}
ranked %>% filter(rank_06 <= 15)  %>% 
    mutate(common_name = 
               fct_reorder(common_name, rank_06, median)) %>%
    select(-c(starts_with("hs"), govern)) %>% 
    gather(key = rank_yr, 
           value = ranking, 
           -common_name) %>% 
    ggplot(aes(x = fct_rev(common_name), 
               y = ranking, 
               color = rank_yr)) + 
    geom_point(position = position_jitter(width = 0, height = 0.6)) +
    coord_flip() + 
    geom_path(aes(group = common_name), 
              lineend = "butt", 
              linejoin = "mitre", 
              arrow = grid::arrow(angle = 15, 
                                  length = unit(.2, "cm"), 
                                  ends = "last", 
                                  type = "closed")) +
    labs(title = "How the 2006 Top 15 Fared",
         caption = "Many of 2006 Top 15 schools \nmoved down by at least one decile.") +
    theme(axis.title.y = element_blank()) 

```